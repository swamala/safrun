// ===========================================
// SAFRUN Prisma Schema
// Social Running & Safety Platform
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum DeviceType {
  IOS
  ANDROID
  WEB
}

enum RunSessionStatus {
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum RunSessionPrivacy {
  PUBLIC
  PRIVATE
  FRIENDS_ONLY
}

enum ParticipantRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum ParticipantStatus {
  INVITED
  JOINED
  LEFT
  REMOVED
}

enum SOSTriggerType {
  MANUAL
  FALL_DETECTION
  NO_MOVEMENT
  ABDUCTION_SPEED
  DEVICE_SNATCH
  HEART_RATE_ANOMALY
}

enum SOSStatus {
  PENDING
  PENDING_VERIFICATION
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  FALSE_ALARM
  ESCALATED
  CANCELLED
}

enum SOSEscalationLevel {
  LEVEL_1
  LEVEL_2
  LEVEL_3
}

enum ResponderStatus {
  NOTIFIED
  ACCEPTED
  EN_ROUTE
  ARRIVED
  DECLINED
  TIMEOUT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  SOS_TRIGGER
  SOS_ACKNOWLEDGE
  LOCATION_UPDATE
  SESSION_JOIN
  SESSION_LEAVE
}

enum FeedItemType {
  RUN_STARTED
  RUN_COMPLETED
  SOS_TRIGGERED
  SOS_RESOLVED
  RESPONDER_JOINED
  SESSION_JOINED
  SESSION_CREATED
  MILESTONE_REACHED
}

enum RunnerStatus {
  IDLE
  RUNNING
  IN_SESSION
  SOS_ACTIVE
}

// ===========================================
// MODELS
// ===========================================

model User {
  id                String         @id @default(uuid())
  email             String?        @unique
  phone             String?        @unique
  passwordHash      String?
  isEmailVerified   Boolean        @default(false)
  isPhoneVerified   Boolean        @default(false)
  status            UserStatus     @default(ACTIVE)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastLoginAt       DateTime?
  
  // Relations
  profile           Profile?
  devices           Device[]
  runSessions       RunSession[]   @relation("SessionCreator")
  participations    RunParticipant[]
  locations         LiveLocation[]
  sosAlerts         SOSAlert[]
  emergencyContacts EmergencyContact[] @relation("UserContacts")
  guardianOf        EmergencyContact[] @relation("GuardianOf")
  sosResponses      SOSResponder[]
  auditLogs         AuditLog[]
  refreshTokens     RefreshToken[]
  feedItems         FeedItem[]
  soloRuns          SoloRun[]

  @@index([email])
  @@index([phone])
  @@index([status])
}

model Profile {
  id                    String   @id @default(uuid())
  userId                String   @unique
  displayName           String
  avatarUrl             String?
  avatarThumbnailUrl    String?
  bio                   String?
  
  // Running Stats
  totalDistance         Float    @default(0)
  totalRuns             Int      @default(0)
  totalDuration         Int      @default(0) // in seconds
  averagePace           Float?
  longestRun            Float    @default(0) // meters
  fastestPace           Float?   // min/km
  currentStreak         Int      @default(0) // days
  longestStreak         Int      @default(0) // days
  lastRunAt             DateTime?
  
  // Safety Settings
  autoSOSEnabled        Boolean  @default(false)
  fallDetectionEnabled  Boolean  @default(false)
  noMovementTimeout     Int      @default(300) // seconds
  sosVerificationTime   Int      @default(10)  // seconds
  shareLocationDefault  Boolean  @default(true)
  anonymousModeEnabled  Boolean  @default(false)
  homeLocationFuzzing   Boolean  @default(true)
  
  // Privacy Settings
  profileVisibility     String   @default("PUBLIC") // PUBLIC, FRIENDS, PRIVATE
  showOnNearbyRadar     Boolean  @default(true)
  allowGroupInvites     Boolean  @default(true)
  
  // SOS Stats
  sosTriggered          Int      @default(0)
  sosResponded          Int      @default(0)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([displayName])
}

model Device {
  id              String     @id @default(uuid())
  userId          String
  deviceType      DeviceType
  deviceId        String     // Unique device identifier
  deviceName      String?
  deviceModel     String?    // e.g., "iPhone 15 Pro", "Pixel 8"
  osVersion       String?    // e.g., "iOS 17.2", "Android 14"
  appVersion      String?    // e.g., "1.0.0"
  pushToken       String?    // Expo push token
  voipToken       String?    // VoIP push token for calls
  fingerprint     String?    // For anomaly detection
  ipAddress       String?
  userAgent       String?
  isActive        Boolean    @default(true)
  lastActiveAt    DateTime   @default(now())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  // Relations
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@index([deviceId])
  @@index([userId])
  @@index([pushToken])
}

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String
  token       String   @unique
  deviceId    String?
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model RunSession {
  id                String            @id @default(uuid())
  creatorId         String
  name              String
  description       String?
  scheduledStartAt  DateTime?
  actualStartAt     DateTime?
  endedAt           DateTime?
  status            RunSessionStatus  @default(SCHEDULED)
  privacy           RunSessionPrivacy @default(PUBLIC)
  
  // Route Info
  startLatitude     Float?
  startLongitude    Float?
  endLatitude       Float?
  endLongitude      Float?
  plannedDistance   Float?            // in meters
  actualDistance    Float?
  routePolyline     String?           // Encoded polyline for route replay
  
  // Settings
  maxParticipants   Int               @default(50)
  allowLateJoin     Boolean           @default(true)
  shareRoutePublic  Boolean           @default(false)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  // Relations
  creator           User              @relation("SessionCreator", fields: [creatorId], references: [id])
  participants      RunParticipant[]
  locations         LiveLocation[]

  @@index([creatorId])
  @@index([status])
  @@index([scheduledStartAt])
  @@index([startLatitude, startLongitude])
}

model SoloRun {
  id              String   @id @default(uuid())
  userId          String
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  isPaused        Boolean  @default(false)
  pausedAt        DateTime?
  
  // Route Info
  startLatitude   Float?
  startLongitude  Float?
  endLatitude     Float?
  endLongitude    Float?
  routePolyline   String?  // Encoded polyline for route replay
  
  // Stats
  distance        Float    @default(0) // meters
  duration        Int      @default(0) // seconds (active time)
  pausedDuration  Int      @default(0) // seconds
  averagePace     Float?   // min/km
  maxSpeed        Float?   // m/s
  calories        Float?
  elevationGain   Float?   // meters
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startedAt])
}

model RunParticipant {
  id              String            @id @default(uuid())
  sessionId       String
  userId          String
  role            ParticipantRole   @default(MEMBER)
  status          ParticipantStatus @default(JOINED)
  
  // Run Stats
  joinedAt        DateTime          @default(now())
  leftAt          DateTime?
  distance        Float             @default(0)
  duration        Int               @default(0) // seconds
  averagePace     Float?
  maxSpeed        Float?
  calories        Float?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  session         RunSession        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}

model LiveLocation {
  id              String      @id @default(uuid())
  userId          String
  sessionId       String?
  soloRunId       String?
  
  // Location Data
  latitude        Float
  longitude       Float
  altitude        Float?
  accuracy        Float?
  speed           Float?      // m/s
  heading         Float?      // degrees
  
  // Smoothed values (for anti-jitter)
  smoothedLat     Float?
  smoothedLng     Float?
  smoothedSpeed   Float?
  
  // Validation
  timestamp       DateTime    @default(now())
  isEncrypted     Boolean     @default(false)
  signatureHash   String?     // HMAC signature for verification
  isSpoofed       Boolean     @default(false)
  
  // Metadata
  batteryLevel    Float?
  isCharging      Boolean?
  networkType     String?     // wifi, cellular, etc.
  
  createdAt       DateTime    @default(now())
  
  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         RunSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([userId, timestamp])
  @@index([sessionId])
  @@index([soloRunId])
  @@index([latitude, longitude])
  @@index([timestamp])
}

model SOSAlert {
  id                  String            @id @default(uuid())
  userId              String
  triggerType         SOSTriggerType
  status              SOSStatus         @default(PENDING)
  escalationLevel     SOSEscalationLevel @default(LEVEL_1)
  
  // Location at trigger
  latitude            Float
  longitude           Float
  latitudeEncrypted   String?           // AES encrypted for storage
  longitudeEncrypted  String?
  
  // Approximate location for responders (fuzzed)
  approxLatitude      Float?
  approxLongitude     Float?
  
  // Countdown (pending state)
  countdownStartedAt  DateTime?
  countdownSeconds    Int               @default(5)
  
  // Timestamps
  triggeredAt         DateTime          @default(now())
  activatedAt         DateTime?         // When countdown completes
  verificationSentAt  DateTime?
  acknowledgedAt      DateTime?
  resolvedAt          DateTime?
  cancelledAt         DateTime?
  
  // Audio/Video
  audioRecordingUrl   String?
  
  // Metadata
  notes               String?
  batteryLevel        Float?
  lastKnownAddress    String?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  // Relations
  user                User              @relation(fields: [userId], references: [id])
  responders          SOSResponder[]

  @@index([userId])
  @@index([status])
  @@index([triggeredAt])
  @@index([latitude, longitude])
}

model SOSResponder {
  id              String          @id @default(uuid())
  sosAlertId      String
  responderId     String
  status          ResponderStatus @default(NOTIFIED)
  
  // Response tracking
  notifiedAt      DateTime        @default(now())
  acceptedAt      DateTime?
  arrivedAt       DateTime?
  declinedAt      DateTime?
  
  // ETA calculation
  distanceMeters  Float?
  estimatedETA    Int?            // seconds
  lastLatitude    Float?
  lastLongitude   Float?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  sosAlert        SOSAlert        @relation(fields: [sosAlertId], references: [id], onDelete: Cascade)
  responder       User            @relation(fields: [responderId], references: [id])

  @@unique([sosAlertId, responderId])
  @@index([sosAlertId])
  @@index([responderId])
}

model EmergencyContact {
  id              String   @id @default(uuid())
  userId          String
  guardianId      String?  // If guardian is also a user
  
  // Contact Info
  name            String
  phone           String
  email           String?
  relationship    String   // spouse, parent, friend, etc.
  
  // Permissions
  canViewLocation Boolean  @default(true)
  canReceiveSOS   Boolean  @default(true)
  isPrimary       Boolean  @default(false)
  
  // Verification
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User     @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
  guardian        User?    @relation("GuardianOf", fields: [guardianId], references: [id])

  @@index([userId])
  @@index([phone])
}

model FeedItem {
  id          String       @id @default(uuid())
  userId      String
  type        FeedItemType
  
  // Related entities
  sessionId   String?
  soloRunId   String?
  sosAlertId  String?
  targetUserId String?     // For responder/join events
  
  // Metadata
  metadata    Json?        // Flexible JSON for type-specific data
  
  // Visibility
  isPublic    Boolean      @default(true)
  
  createdAt   DateTime     @default(now())
  
  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([sessionId])
}

model AuditLog {
  id          String      @id @default(uuid())
  userId      String?
  action      AuditAction
  resource    String      // e.g., "user", "session", "sos"
  resourceId  String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  
  // Relations
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

// ===========================================
// STATISTICS CACHING (for fast queries)
// ===========================================

model WeeklyStats {
  id            String   @id @default(uuid())
  userId        String
  weekStart     DateTime // Start of week (Monday)
  
  totalDistance Float    @default(0)
  totalDuration Int      @default(0)
  totalRuns     Int      @default(0)
  avgPace       Float?
  calories      Float    @default(0)
  
  sosTriggered  Int      @default(0)
  sosResponded  Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, weekStart])
  @@index([userId])
  @@index([weekStart])
}

model MonthlyStats {
  id            String   @id @default(uuid())
  userId        String
  monthStart    DateTime // Start of month (1st)
  
  totalDistance Float    @default(0)
  totalDuration Int      @default(0)
  totalRuns     Int      @default(0)
  avgPace       Float?
  calories      Float    @default(0)
  
  sosTriggered  Int      @default(0)
  sosResponded  Int      @default(0)
  
  longestRun    Float    @default(0)
  fastestPace   Float?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, monthStart])
  @@index([userId])
  @@index([monthStart])
}
